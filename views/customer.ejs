<%- include('partials/header') %>





<br><br><br>
    <div class="jumbotron text-center">
        <div class="container">

            <% if (locals.data) { %>
                <h1 class="display-4"><%= data.full_name %></h1>
                <p class="lead"><%= data.home_address %></p>
                <br><hr><br>
    

                <form class="item" method="post" action="/updateCustomer/<%= data.id %>">
                    <div class="d-flex justify-content-between mb-3">
                        <button class="update btn btn-primary" type="submit" name="action" value="update">Update Customer</button>
                        <button class="delete btn btn-danger" type="button" onclick="confirmDelete(<%= data.id %>)">Delete Customer</button>
                    </div>
                    
                    <div class="container" style="max-width: 800px;">
                        <!-- Basic Information -->
                        <h5 class="text-left mb-3">Basic Information</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="fullName" class="form-label">Customer Code</label>
                                <input type="text" class="form-control" id="customID" name="customID" value="<%= data.sort_order || '' %>">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="fullName" class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="fullName" name="fullName" value="<%= data.full_name || '' %>">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="jobNo" class="form-label">Job Number</label>
                                <input type="text" class="form-control" id="jobNo" name="jobNo" value="<%= data.job_no || '' %>">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="homeAddress" class="form-label">Home Address</label>
                                <input type="text" class="form-control" id="homeAddress" name="homeAddress" value="<%= data.home_address || '' %>">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="siteLocation" class="form-label">Site Location</label>
                                <input type="text" class="form-control" id="siteLocation" name="siteLocation" value="<%= data.site_location || '' %>">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="primaryPhone" class="form-label">Primary Phone</label>
                                <input type="text" class="form-control" id="primaryPhone" name="primaryPhone" value="<%= data.primary_phone || '' %>">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="primaryEmail" class="form-label">Primary Email</label>
                                <input type="email" class="form-control" id="primaryEmail" name="primaryEmail" value="<%= data.primary_email || '' %>">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="contactOther" class="form-label">Additional Contact Info</label>
                            <textarea class="form-control" id="contactOther" name="contactOther" rows="2"><%= data.contact_other || '' %></textarea>
                        </div>

                        <!-- Job Information -->
                        <h5 class="text-left mb-3 mt-4">Job Information</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="buildingType" class="form-label">Building Type</label>
                                <input type="text" class="form-control" id="buildingType" name="buildingType" value="<%= data.building_type || '' %>">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="slabSize" class="form-label">Slab Size</label>
                                <input type="text" class="form-control" id="slabSize" name="slabSize" value="<%= data.slab_size || '' %>">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="permitType" class="form-label">Permit Type</label>
                                <input type="text" class="form-control" id="permitType" name="permitType" value="<%= data.permit_type || '' %>">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="councilResponsible" class="form-label">Council Responsible</label>
                                <input type="text" class="form-control" id="councilResponsible" name="councilResponsible" value="<%= data.council_responsible || '' %>">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="workSource" class="form-label">Work Source</label>
                                <select class="form-control" id="workSource" name="workSource">
                                    <option value="">Select Source</option>
                                    <option value="BPA" <%= data.work_source === 'BPA' ? 'selected' : '' %>>BPA (Self-sourced)</option>
                                    <option value="E" <%= data.work_source === 'E' ? 'selected' : '' %>>Eureka Sheds</option>
                                    <option value="Best Sheds" <%= data.work_source === 'Best Sheds' ? 'selected' : '' %>>Best Sheds</option>
                                    <option value="Facebook" <%= data.work_source === 'Facebook' ? 'selected' : '' %>>Facebook Marketing</option>
                                    <option value="Other" <%= data.work_source === 'Other' ? 'selected' : '' %>>Other</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" id="ownerBuilderPermit" name="ownerBuilderPermit" <%= data.owner_builder_permit ? 'checked' : '' %>>
                                    <label class="form-check-label" for="ownerBuilderPermit">
                                        Owner Builder Permit Required
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Timeline Information -->
                        <h5 class="text-left mb-3 mt-4">Timeline</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="dateOrdered" class="form-label">Date Ordered</label>
                                <input type="date" class="form-control" id="dateOrdered" name="dateOrdered" 
                                       value="<%= data.date_ordered ? new Date(data.date_ordered).toISOString().substring(0, 10) : '' %>">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="dateBpApplied" class="form-label">BP Applied Date</label>
                                <input type="date" class="form-control" id="dateBpApplied" name="dateBpApplied" 
                                       value="<%= data.date_bp_applied ? new Date(data.date_bp_applied).toISOString().substring(0, 10) : '' %>">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="dateBpIssued" class="form-label">BP Issued Date</label>
                                <input type="date" class="form-control" id="dateBpIssued" name="dateBpIssued" 
                                       value="<%= data.date_bp_issued ? new Date(data.date_bp_issued).toISOString().substring(0, 10) : '' %>">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="dateCompleted" class="form-label">Date Completed</label>
                                <input type="date" class="form-control" id="dateCompleted" name="dateCompleted" 
                                       value="<%= data.date_completed ? new Date(data.date_completed).toISOString().substring(0, 10) : '' %>">
                            </div>
                        </div>

                        <!-- Financial Information -->
                        <h5 class="text-left mb-3 mt-4">Financial Information</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="quotedEstimate" class="form-label">Quoted Estimate ($)</label>
                                <input type="number" step="0.01" class="form-control" id="quotedEstimate" name="quotedEstimate" 
                                       value="<%= data.quoted_estimate || '' %>">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="invoicesCollected" class="form-label">Invoices Collected ($)</label>
                                <input type="number" step="0.01" class="form-control" id="invoicesCollected" name="invoicesCollected" 
                                       value="<%= data.invoices_collected || '' %>">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="feesPaidOut" class="form-label">Fees Paid Out ($)</label>
                                <input type="number" step="0.01" class="form-control" id="feesPaidOut" name="feesPaidOut" 
                                       value="<%= data.fees_paid_out || '' %>">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="jobEarnings" class="form-label">Job Earnings ($)</label>
                                <input type="number" step="0.01" class="form-control" id="jobEarnings" name="jobEarnings" 
                                       value="<%= data.job_earnings || '' %>">
                            </div>
                        </div>

                        <!-- Action Tracking -->
                        <h5 class="text-left mb-3 mt-4">Action Tracking</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="currentStatus" class="form-label">Current Status</label>
                                <input type="text" class="form-control" id="currentStatus" name="currentStatus" 
                                       value="<%= data.current_status || '' %>">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="followUp" class="form-label">Follow Up Date</label>
                                <% let followUp = ""; %>
                                <% if (data.follow_up) { followUp = new Date(data.follow_up).toISOString().substring(0, 16); } %>
                                <input type="datetime-local" class="form-control" id="followUp" name="followUp" value="<%= followUp %>">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="nextActionDescription" class="form-label">Next Action Description</label>
                            <textarea class="form-control" id="nextActionDescription" name="nextActionDescription" rows="3"><%= data.next_action_description || '' %></textarea>
                        </div>

                        <!-- Last Payment Information (Read-only) -->
                        <h5 class="text-left mb-3 mt-4">Last Payment Information</h5>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="lastPaymentDate" class="form-label">Last Payment Date</label>
                                <input type="date" class="form-control" id="lastPaymentDate" name="lastPaymentDate" readonly
                                       value="<%= data.last_payment_date ? new Date(data.last_payment_date).toISOString().substring(0, 10) : '' %>">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="lastPaymentAmount" class="form-label">Last Payment Amount ($)</label>
                                <input type="number" step="0.01" class="form-control" id="lastPaymentAmount" name="lastPaymentAmount" readonly
                                       value="<%= data.last_payment_amount || '' %>">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="lastPaymentDescription" class="form-label">Last Payment Description</label>
                                <input type="text" class="form-control" id="lastPaymentDescription" name="lastPaymentDescription" readonly
                                       value="<%= data.last_payment_description || '' %>">
                            </div>
                        </div>
                    </div>
                </form>





                <form class="item" action="/addBuild" method="post">
                    <div class="container" style="max-width: 600px;">
                    <div class="mb-3">
                        <select class="form-control" name="product_id" id="product_id" autofocus="true">
                            <% products.forEach(product => { %>
                                <option value="<%= product.id %>" <% if (data.current_status === product.display_text) { %>selected<% } %>><%= product.display_text %></option>
                            <% }); %>
                        </select >
                        <button class="btn btn-primary btn-sm py-1 px-2" type="submit" name="list" value="submit" style="font-size: 0.85em; line-height: 1;">save changes</button>
                    </div>
                    <input type="hidden" name="customer_id" placeholder="builds.customer_id" value="<%= data.id %>" autocomplete="off" />
                    <% let enquiryDate = new Date().toISOString().substring(0, 16); %>
                    <input type="datetime-local" name="enquiry_date" value="<%= enquiryDate %>" autocomplete="off"  style="display:none;"  />
                    
                    </div>
                </form>      




            <% } else { %>
                <h1 class="display-3">Add New Customer</h1>
                <form class="item" method="post" action="/addCustomer" method="post">
                    <div>
                        <label for="fullName">Full Name:</label>
                        <input type="text" id="fullName" name="fullName" placeholder="customer name" autocomplete="off" autofocus="true" >
                    </div>
                    <div>
                        <label for="homeAddress">Build Address:</label>
                        <input type="text" id="homeAddress" name="homeAddress" placeholder="build address" autocomplete="off" >
                    </div>
                    <div>
                        <label for="primaryPhone">Primary Phone:</label>
                        <input type="text" id="primaryPhone" name="primaryPhone" placeholder="primary phone" autocomplete="off" >
                    </div>
                    <div>
                        <label for="primaryEmail">Primary Email:</label>
                        <input type="text" id="primaryEmail" name="primaryEmail" placeholder="primary email" autocomplete="off" >
                    </div>
                    <div>
                        <label for="customID">Code:</label>
                        <input type="text" id="customID" name="customID" placeholder="BPA00123" autocomplete="off" >
                    </div>
                    <div>
                        <label for="currentStatus">Add Workflow:</label>
                        <input type="text" id="currentStatus" name="currentStatus" placeholder="Initial enquiry" readonly>
                    </div>

                    
                        <button class="add" type="submit" name="list" value="submit">add Customer</button>
                    
                </form>
            <% } %>

            <br><hr><br>
            <!-- If you are looking at an existing customer then add a div to update and display the customer emails / -->
            <% if (locals && locals.data ) { %>
                <div>
                    <h3>Customer Emails</h3>

                        <a href="/checkemail?btn=105a&customer_id=<%= data.id %>&returnto=customer/<%= data.id %>" class="btn btn-secondary btn-sm py-1 px-2" title="Update" style="font-size: 0.85em; line-height: 1;">
                            <i class="bi bi-arrow-clockwise"></i> rebuild email list
                        </a>                    
                    <table class="table table-striped table-bordered">
                        <thead>
                            <tr class="table-primary">
                                <th>ID</th>
                                <th>From</th>
                                <th>Subject</th>
                                <th>Body</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (locals.emails) { %>
                                <% for (let i in emails) { %>
                                    <tr class="email-row">
                                        <td><%= emails[i].id %></td>
                                        <td><%= emails[i].display_name %></td>
                                        <td><%= emails[i].subject %></td>
                                        <td><%- emails[i].message_text.replace(/\n/g, '<br>') %></td>
                                    </tr>
                                <% } %>   
                            <% } %>
                        </tbody>
                    </table>               
                    
                </div>
            <% } %>



            <!-- List builds against the customer -->
            <br><hr><br>
            <h3>History</h3>
            <table class="table table-hover ">
                <thead>
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Product</th>
                        <th scope="col">Enquiry Date</th>
                        <th scope="col"></th>
                    </tr>
                </thead>
                <tbody>
                    <% if (locals.builds) { %>
                        <% for (let i in builds) { %>
                            <tr class="build-row">
                                <form method="post" action="/updateBuild/<%= builds[i].id %>">
                                    <th scope="row"><%= builds[i].id %>
                                        <input type="hidden" name="id" value="<%= builds[i].id %>">
                                        <input type="hidden" name="customer_id" value="<%= builds[i].customer_id %>">
                                    </th>
                                    <td>
                                        <select name="product_id" id="product_id">
                                            <% products.forEach(product => { %>
                                                <option value="<%= product.id %>" <% if (builds[i].product_id === product.id) { %> selected <% } %>><%= product.display_text %></option>
                                            <% }); %>
                                        </select>                                               
                                    </td>
                                    <td>
                                        <input type="datetime-local" name="enquiry_date" value="
                                        <% if (builds[i].enquiry_date) { %>
                                            <%= builds[i].enquiry_date.toISOString().substring(0, 16) %>
                                        <% } else { %>
                                            <%= new Date().toISOString().substring(0, 16) %>
                                        <% } %>
                                        ">
                                    </td>
                                    <td>
                                        <button class="btn btn-light" type="submit" name="action" value="update">Update Site</button>
                                        <button class="btn btn-light" type="submit" name="action" value="delete">Delete Site</button>
                                        <button class="btn btn-light" type="submit" name="action" value="view">Task</button>
                                        
                                    </td>
                                </form>                       
                            </tr>
                            <tr class="detail-row" style="display: none;">
                                <td colspan="4">Details for build <%= builds[i].id %></td>
                            </tr>
                        <% } %>   
                    <% } %>
                </tbody>
            </table>

        </div>
    </div>





    <%- include('partials/footer') %>


    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const buildRows = document.querySelectorAll(".build-row");
        buildRows.forEach(function(buildRow) {
            buildRow.addEventListener("click", function() {
                const detailRow = buildRow.nextElementSibling;
                if (detailRow.classList.contains("detail-row")) {
                    detailRow.style.display = detailRow.style.display === "none" ? "" : "none";
                }
            });
        });
    });

    document.addEventListener("DOMContentLoaded", function() {
        const viewBtns = document.querySelectorAll(".view-btn");
        viewBtns.forEach(function(viewBtn) {
            viewBtn.addEventListener("click", function() {
                const buildId = viewBtn.getAttribute("data-build-id");
                const detailRow = document.querySelector(".detail-row[data-build-id='" + buildId + "']");
                if (detailRow) {
                    detailRow.style.display = detailRow.style.display === "none" ? "" : "none";
                }
            });
        });
    });

    function confirmDelete(customerId) {
            if (confirm('Are you sure you want to delete this customer?')) {
                // Create a hidden form to submit the delete action
                const form = document.createElement('form');
                form.method = 'post';
                form.action = '/updateCustomer/' + customerId;

                // Create a hidden input for the action
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'action';
                input.value = 'delete';

                // Append the input to the form
                form.appendChild(input);

                // Append the form to the body and submit it
                document.body.appendChild(form);
                form.submit();
            }
        }    
</script>

views/customer.ejs